<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Moderator - Contest Results</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { box-sizing: border-box; font-family: 'Segoe UI', -apple-system, sans-serif; margin: 0; padding: 0; }
        
        body { 
            background: linear-gradient(135deg, #f0f4f8 0%, #dbeafe 100%);
            min-height: 100vh;
            display: flex;
        }

        /* Sidebar */
        .sidebar { 
            width: 280px; 
            background: #1a237e; 
            color: white; 
            padding: 30px 20px; 
            position: fixed; 
            height: 100vh;
            box-shadow: 4px 0 10px rgba(0,0,0,0.1);
        }
        .sidebar h2 { font-size: 22px; margin-bottom: 30px; border-bottom: 1px solid #3949ab; padding-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .nav-item { padding: 14px 16px; color: #c5cae9; cursor: pointer; display: flex; align-items: center; gap: 12px; text-decoration: none; border-radius: 10px; margin-bottom: 8px; transition: 0.3s; }
        .nav-item:hover { background: #283593; color: white; }
        .nav-item.active { background: #3f51b5; color: white; font-weight: bold; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }

        /* Main Content */
        .main-content { flex: 1; padding: 40px; margin-left: 280px; }
        
        .header-flex { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; }
        h1 { color: #1a237e; font-size: 28px; }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .stat-card { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-left: 5px solid #3f51b5; }
        .stat-card h4 { color: #64748b; font-size: 13px; text-transform: uppercase; margin-bottom: 10px; }
        .stat-card p { font-size: 28px; font-weight: bold; color: #1a237e; }

        /* Controls Card */
        .card { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 30px; border: 1px solid #e2e8f0; }
        .table-controls { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        
        input[type="text"], select { padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px; outline: none; transition: 0.3s; }
        input[type="text"]:focus { border-color: #3f51b5; }
        .search-bar { flex: 1; min-width: 300px; }

        /* Table Styling */
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th { text-align: left; padding: 16px; background: #f8f9fe; color: #5c6bc0; font-weight: 600; text-transform: uppercase; font-size: 12px; border-bottom: 2px solid #edf2f7; }
        td { padding: 16px; border-bottom: 1px solid #edf2f7; color: #334155; font-size: 14px; }
        tr:hover td { background: #f8fafc; }

        /* Components */
        .btn-export { background: #10b981; color: white; border: none; padding: 12px 24px; border-radius: 10px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: 0.3s; }
        .btn-export:hover { background: #059669; transform: translateY(-2px); }
        .score-pill { background: #e0e7ff; color: #3730a3; padding: 6px 14px; border-radius: 20px; font-weight: bold; display: inline-block; }
        .rank-badge { width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: #f1f5f9; font-weight: bold; font-size: 12px; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2><i class="fas fa-shield-alt"></i> Moderator</h2>
        <a class="nav-item" href="moderator.html"><i class="fas fa-home"></i> Dashboard</a>
        <a class="nav-item" href="create-contest.html"><i class="fas fa-plus-circle"></i> Contest Creator</a>
        <a class="nav-item" href="create-debug-contest.html"><i class="fas fa-bug"></i> Debug Creator</a>
        <a class="nav-item active" href="results.html"><i class="fas fa-file-invoice"></i> Results & Export</a>
        <a class="nav-item" onclick="logout()" style="margin-top: auto;"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </div>

    <div class="main-content">
        <div class="header-flex">
            <h1><i class="fas fa-chart-line"></i> Contest Results Report</h1>
            <button class="btn-export" onclick="exportToCSV()">
                <i class="fas fa-file-csv"></i> Export to CSV
            </button>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h4>Total Participants</h4>
                <p id="totalParticipants">0</p>
            </div>
            <div class="stat-card">
                <h4>Average Score</h4>
                <p id="avgScore">0</p>
            </div>
            <div class="stat-card">
                <h4>Top Institution</h4>
                <p id="topInstitution" style="font-size: 18px;">-</p>
            </div>
        </div>
        
        <div class="card">
            <div class="table-controls">
                <input type="text" id="searchInput" class="search-bar" placeholder="Search by name, email or institution..." oninput="filterTable()">
                <select id="sortSelect" onchange="filterTable()">
                    <option value="score-desc">Score (High to Low)</option>
                    <option value="score-asc">Score (Low to High)</option>
                    <option value="name">Name (A-Z)</option>
                </select>
            </div>

            <table>
                <thead>
                    <tr>
                        <th style="width: 60px;">Rank</th>
                        <th>Student Name</th>
                        <th>Email Address</th>
                        <th>Institution</th>
                        <th>Final Score</th>
                    </tr>
                </thead>
                <tbody id="resultsTable">
                    </tbody>
            </table>
        </div>
    </div>

    <script>
        const API_URL = '/api/moderator';
        const token = localStorage.getItem('token');
        let allStudents = [];

        if (!token || localStorage.getItem('role') !== 'moderator') {
            window.location.href = 'index.html';
        }

        async function fetchResults() {
            try {
                const res = await fetch(`${API_URL}/results`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!res.ok) throw new Error("Failed to fetch results");
                
                allStudents = await res.json();
                updateStats(allStudents);
                renderTable(allStudents);
            } catch (err) {
                console.error("Fetch Results Error:", err);
            }
        }

        function updateStats(students) {
            document.getElementById('totalParticipants').textContent = students.length;
            
            const avg = students.length > 0 
                ? (students.reduce((acc, s) => acc + (s.score || 0), 0) / students.length).toFixed(1) 
                : 0;
            document.getElementById('avgScore').textContent = avg;

            const instCounts = {};
            students.forEach(s => {
                const inst = s.college || 'Individual';
                instCounts[inst] = (instCounts[inst] || 0) + 1;
            });
            const topInst = Object.keys(instCounts).reduce((a, b) => instCounts[a] > instCounts[b] ? a : b, '-');
            document.getElementById('topInstitution').textContent = topInst;
        }

        function renderTable(students) {
            const tbody = document.getElementById('resultsTable');
            tbody.innerHTML = students.map((s, index) => `
                <tr>
                    <td><div class="rank-badge">${index + 1}</div></td>
                    <td><strong>${s.name || 'N/A'}</strong></td>
                    <td style="color: #64748b;">${s.email}</td>
                    <td><i class="fas fa-university" style="color: #94a3b8; margin-right: 8px;"></i>${s.college || 'Individual'}</td>
                    <td><span class="score-pill">${s.score || 0}</span></td>
                </tr>
            `).join('');
        }

        function filterTable() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const sort = document.getElementById('sortSelect').value;

            let filtered = allStudents.filter(s => 
                (s.name && s.name.toLowerCase().includes(term)) || 
                s.email.toLowerCase().includes(term) || 
                (s.college && s.college.toLowerCase().includes(term))
            );

            if (sort === 'score-desc') filtered.sort((a, b) => b.score - a.score);
            else if (sort === 'score-asc') filtered.sort((a, b) => a.score - b.score);
            else if (sort === 'name') filtered.sort((a, b) => a.name.localeCompare(b.name));

            renderTable(filtered);
        }

        function exportToCSV() {
            const rows = [["Rank", "Student Name", "Email Address", "Institution", "Final Score"]];
            const tableRows = document.querySelectorAll("table tr");
            
            // Skip the first row (header) in the DOM selection since we defined it manually
            for(let i = 1; i < tableRows.length; i++) {
                const cols = tableRows[i].querySelectorAll("td");
                const rowData = Array.from(cols).map(col => `"${col.innerText.trim()}"`);
                rows.push(rowData);
            }

            let csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "contest_results.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function logout() {
            localStorage.clear();
            window.location.href = 'index.html';
        }

        document.addEventListener('DOMContentLoaded', fetchResults);
    </script>
</body>
</html>
